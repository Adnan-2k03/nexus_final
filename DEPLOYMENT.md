# Deployment Guide: Railway + Vercel + Cloudflare R2 + 100ms

This guide walks you through deploying your GameMatch app using the optimal architecture:
- **Frontend**: Vercel (free 100GB bandwidth)
- **Backend + Database**: Railway ($5-20/month)
- **File Storage**: Cloudflare R2 ($0.75 for 50GB)
- **Voice/Video**: 100ms (10,000 free minutes/month)

## Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Vercel     ‚îÇ ‚Üí React Frontend (Global CDN)
‚îÇ   (Free)     ‚îÇ ‚Üí 100GB bandwidth
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì HTTPS API calls
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Railway    ‚îÇ ‚Üí Express Backend
‚îÇ  ($5-20/mo)  ‚îÇ ‚Üí PostgreSQL Database
‚îÇ              ‚îÇ ‚Üí WebSocket Server
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚Üí Cloudflare R2 (file uploads)
       ‚îî‚îÄ‚îÄ‚Üí 100ms (voice/video calls)
```

---

## Part 1: Setup Cloudflare R2 (File Storage)

### Step 1: Create R2 Bucket

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com) ‚Üí R2
2. Click **Create bucket**
3. Name it: `gamematch-uploads` (or your choice)
4. Click **Create bucket**

### Step 2: Get R2 Credentials

1. Go to R2 ‚Üí Manage R2 API Tokens
2. Click **Create API token**
3. Select **Edit permissions**:
   - Object Read & Write
4. Apply to specific bucket: `gamematch-uploads`
5. Click **Create API token**
6. **Save these values** (you'll need them for Railway):
   - Access Key ID
   - Secret Access Key
   - Account ID (in R2 overview page)

### Step 3: (Optional) Enable Public Access

If you want files to be publicly accessible via URL:

1. Go to your bucket ‚Üí Settings
2. Enable **Public Access**
3. Note your **Public Bucket URL**: `https://pub-[hash].r2.dev`

---

## Part 2: Setup 100ms (Voice/Video)

### Step 1: Create 100ms Account

1. Go to [100ms.live](https://www.100ms.live/)
2. Sign up for free account
3. Create a new app

### Step 2: Get Credentials

1. Go to your app ‚Üí Developer Section
2. Copy these values:
   - **App Access Key**
   - **App Secret**
3. Create a template for your rooms:
   - Go to Templates ‚Üí Create Template
   - Set room type: **Video Conferencing** or **Audio Room**
   - Note the **Template ID**

---

## Part 3: Deploy Backend to Railway

### Step 1: Prepare Your Code

1. Make sure your code is pushed to GitHub
2. Ensure `package.json` has these scripts:
```json
{
  "scripts": {
    "build": "tsc",
    "start": "NODE_ENV=production node dist/index.js",
    "db:push": "drizzle-kit push"
  }
}
```

### Step 2: Create Railway Project

1. Go to [Railway.app](https://railway.app)
2. Sign up/login with GitHub
3. Click **New Project**
4. Select **Deploy from GitHub repo**
5. Choose your repository
6. Railway will auto-detect Node.js and start deploying

### Step 3: Add PostgreSQL Database

1. In your Railway project, click **+ New**
2. Select **Database** ‚Üí **Add PostgreSQL**
3. Railway automatically creates `DATABASE_URL` environment variable

### Step 4: Push Database Schema

Railway will run your build command, but you need to push the schema:

1. In Railway project ‚Üí your service ‚Üí Settings
2. Add custom **Build Command**:
```bash
npm install && npm run db:push --force && npm run build
```

**Important**: This will create all database tables and indexes automatically from your Drizzle schema, including:
- All tables with proper foreign keys and constraints
- All indexes for optimal query performance
- New `hms_room_id` field in voice_channels table for 100ms integration

### Step 5: Add Environment Variables

In Railway project ‚Üí your service ‚Üí Variables, add:

```bash
# Database (auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Session Secret (generate a random string)
SESSION_SECRET=your-super-secret-random-string-here

# ‚ö†Ô∏è SECURITY CRITICAL: Google OAuth (REQUIRED for production)
# DO NOT set AUTH_DISABLED in production - it allows anyone to impersonate any user!
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

# Cloudflare R2
R2_ACCOUNT_ID=your-r2-account-id
R2_ACCESS_KEY_ID=your-r2-access-key
R2_SECRET_ACCESS_KEY=your-r2-secret-key
R2_BUCKET_NAME=gamematch-uploads
R2_PUBLIC_URL=https://pub-[hash].r2.dev

# 100ms
HMS_APP_ACCESS_KEY=your-100ms-access-key
HMS_APP_SECRET=your-100ms-secret
HMS_TEMPLATE_ID=your-template-id

# VAPID (for push notifications - generated on first run)
# These will be logged on first deployment, add them here after
VAPID_PUBLIC_KEY=
VAPID_PRIVATE_KEY=
VAPID_SUBJECT=mailto:support@yourdomain.com

# Node Environment
NODE_ENV=production
BACKEND_ONLY=true

# CORS - CRITICAL for Vercel frontend
# Add your Vercel domain(s) - comma-separated
CORS_ORIGIN=https://your-project.vercel.app,https://your-project-git-main.vercel.app

# ‚ö†Ô∏è SECURITY WARNING: DO NOT SET AUTH_DISABLED IN PRODUCTION
# AUTH_DISABLED=true allows passwordless login - ONLY use in development!
# In production, Google OAuth is REQUIRED for secure authentication.
```

### Step 6: Generate Public Domain

1. Go to your service ‚Üí Settings ‚Üí Networking
2. Click **Generate Domain**
3. Copy the URL (e.g., `https://backend-production-xxxx.up.railway.app`)
4. **Save this URL** - you'll need it for Vercel

### Step 7: Verify Deployment

1. Click on **Deployments** tab
2. Check logs for successful startup
3. Test your API: `https://your-backend.up.railway.app/api/health`

---

## Part 4: Deploy Frontend to Vercel

### Step 1: Update Frontend Environment

Create `.env.production` in your frontend folder:

```bash
# Replace with your Railway backend URL
VITE_API_URL=https://backend-production-xxxx.up.railway.app
VITE_WS_URL=wss://backend-production-xxxx.up.railway.app
```

### Step 2: Deploy to Vercel

1. Go to [Vercel.com](https://vercel.com)
2. Sign up/login with GitHub
3. Click **Add New** ‚Üí **Project**
4. Import your GitHub repository
5. Configure build settings:
   - **Framework Preset**: Vite
   - **Root Directory**: `./` (or `./client` if in monorepo)
   - **Build Command**: `npm run build`
   - **Output Directory**: `dist`

### Step 3: Add Environment Variables

In Vercel project ‚Üí Settings ‚Üí Environment Variables:

```bash
VITE_API_URL=https://backend-production-xxxx.up.railway.app
VITE_WS_URL=wss://backend-production-xxxx.up.railway.app
```

### Step 4: Deploy

1. Click **Deploy**
2. Wait for build to complete (~2 minutes)
3. Your site will be live at: `https://your-project.vercel.app`

---

## Part 5: Configure CORS and CSP

### Backend CORS Configuration

**IMPORTANT**: Your backend is already configured to handle CORS properly for split deployments.

Update your Railway backend environment variables to allow your Vercel domain:

```bash
# In Railway ‚Üí Variables ‚Üí Add these:
CORS_ORIGIN=https://your-project.vercel.app,https://your-project-git-main.vercel.app
BACKEND_ONLY=true
NODE_ENV=production
```

**How it works:**
- The backend automatically allows the origins specified in `CORS_ORIGIN` (comma-separated)
- In development (Replit), it allows `localhost:5173` and `localhost:5000` by default
- In production (Railway), you MUST set `CORS_ORIGIN` to your Vercel URLs
- Setting `BACKEND_ONLY=true` ensures Railway only serves the API (no static files)

### Frontend CSP Configuration

**IMPORTANT**: The Content Security Policy in `client/index.html` has been configured to allow Railway backend connections.

The CSP `connect-src` directive includes:
```
connect-src 'self' ... https://*.railway.app wss://*.railway.app ...
```

This allows your Vercel frontend to make API calls to your Railway backend.

**Common CORS Issues:**
- ‚ùå **405 Method Not Allowed**: Your Vercel URL is not in `CORS_ORIGIN`
- ‚ùå **No 'Access-Control-Allow-Origin' header**: Same issue, add your domain to `CORS_ORIGIN`
- ‚ùå **CSP violations (Refused to connect)**: Railway URL is not in CSP `connect-src` (already fixed)
- ‚úÖ **Solution**: Always include both your production and preview Vercel URLs in `CORS_ORIGIN`

---

## Part 6: Testing

### Test Checklist:

- [ ] Frontend loads on Vercel URL
- [ ] Can create account / login
- [ ] API calls work (check browser console)
- [ ] Database operations work
- [ ] File upload works (profile image)
- [ ] Voice channel creation works
- [ ] WebSocket connection works

### Common Issues:

**1. CORS Errors**
- Solution: Verify `CORS_ORIGIN` includes your Vercel URL

**2. API calls fail with 404**
- Solution: Check `VITE_API_URL` includes `https://` protocol

**3. WebSocket connection fails**
- Solution: Use `wss://` (not `ws://`) for production

**4. Database connection errors**
- Solution: Check `DATABASE_URL` is set correctly in Railway

**5. File uploads fail**
- Solution: Verify all R2 credentials are set correctly

---

## Cost Breakdown

### Monthly Costs:

| Service | Cost | What You Get |
|---------|------|--------------|
| **Vercel** | **$0** | 100GB bandwidth, unlimited requests |
| **Railway** | **$5-20** | Backend + PostgreSQL (pay per usage) |
| **Cloudflare R2** | **$0.75** | 50GB storage, 1M reads, 1M writes |
| **100ms** | **$0** | 10,000 minutes/month free |
| **TOTAL** | **~$6-21/month** | Full production stack |

### Railway Usage Estimate:
- 1 backend service (512MB RAM, 0.5 CPU): ~$10/mo
- 1 PostgreSQL database (1GB storage): ~$5/mo
- **Typical total**: $15-20/month for moderate traffic

---

## Scaling Tips

### When to Upgrade:

**Vercel**:
- Free tier is generous for most MVPs
- Upgrade to Pro ($20/mo) only if you exceed 100GB bandwidth

**Railway**:
- Monitor usage in dashboard
- Auto-scales compute based on traffic
- Add more database storage as needed

**Cloudflare R2**:
- First 10GB free per month
- After that: $0.015/GB/month (very cheap)

**100ms**:
- First 10,000 minutes free
- After: $0.0099/minute (~$99 for 10,000 more minutes)

---

## Maintenance

### Database Backups (Railway):
- Railway provides automatic daily backups
- Can restore from any backup in dashboard

### Monitoring:
- Railway: Built-in metrics and logs
- Vercel: Analytics dashboard shows traffic
- 100ms: Dashboard shows usage and active sessions

### Updates:
- Push to GitHub ‚Üí Auto-deploys to Railway & Vercel
- Database migrations: Run `npm run db:push` locally, then deploy

---

## Advanced: Custom Domain

### Add Custom Domain to Vercel:

1. Go to Vercel project ‚Üí Settings ‚Üí Domains
2. Add your domain (e.g., `gamematch.app`)
3. Update DNS records as instructed
4. SSL certificate auto-generated

### Update Railway CORS:

```bash
CORS_ORIGIN=https://gamematch.app,https://www.gamematch.app
```

---

## Support

### Documentation:
- [Railway Docs](https://docs.railway.app)
- [Vercel Docs](https://vercel.com/docs)
- [Cloudflare R2 Docs](https://developers.cloudflare.com/r2/)
- [100ms Docs](https://www.100ms.live/docs)

### Community:
- Railway Discord
- Vercel Discord
- 100ms Discord

---

## Quick Deploy Commands

```bash
# Deploy backend changes
git push origin main  # Auto-deploys to Railway

# Deploy frontend changes  
git push origin main  # Auto-deploys to Vercel

# Update database schema
npm run db:push --force  # Run locally, Railway will sync on next deploy

# View Railway logs
railway logs

# View Vercel logs
vercel logs
```

---

üéâ **You're all set!** Your app is now running on production infrastructure for ~$6-21/month.
